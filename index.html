<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- iOS PWA 專用設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cycle Keeper">

    <title>Cycle Keeper | 週期管家 (Cloud)</title>
    
    <!-- 圖示設定 -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#030712' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #030712; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .smooth-transition { transition: all 0.3s ease; }
        @keyframes pulse-glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .animate-pulse-slow { animation: pulse-glow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        /* Loading Spinner */
        .spinner { border: 2px solid rgba(255,255,255,0.1); border-left-color: #34D399; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 pb-20">

    <div id="app" class="max-w-md mx-auto relative">
        
        <!-- 雲端狀態列 -->
        <div class="fixed top-0 left-0 w-full z-50 pointer-events-none">
            <div class="max-w-md mx-auto relative">
                <div v-if="syncStatus !== 'idle'" 
                     class="absolute top-4 left-4 flex items-center gap-2 px-3 py-1.5 rounded-full backdrop-blur-md text-xs font-medium transition-all duration-300"
                     :class="syncStatus === 'saving' || syncStatus === 'loading' ? 'bg-indigo-500/20 text-indigo-300 border border-indigo-500/30' : 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30'">
                    <div v-if="syncStatus === 'saving' || syncStatus === 'loading'" class="spinner"></div>
                    <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>{{ syncText }}</span>
                </div>
            </div>
        </div>

        <header class="flex items-center justify-between mb-8 mt-2">
            <div class="flex items-center gap-3">
                <svg class="w-10 h-10 text-emerald-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                     <path d="M256 128C326.7 128 384 185.3 384 256C384 326.7 326.7 384 256 384C185.3 384 128 326.7 128 256" stroke="currentColor" stroke-width="40" stroke-linecap="round" fill="none"/>
                     <circle cx="256" cy="256" r="30"/>
                     <path d="M128 256L96 200M128 256L160 200" stroke="currentColor" stroke-width="40" stroke-linecap="round" fill="none"/>
                </svg>
                <div>
                    <h1 class="text-xl font-bold tracking-wide text-white">Cycle Keeper</h1>
                    <p class="text-xs text-gray-400">Cloud Sync</p>
                </div>
            </div>
            <button @click="openAddModal" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-full p-3 shadow-lg smooth-transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </header>

        <!-- Loading 遮罩 (初次載入時) -->
        <div v-if="isInitialLoading" class="flex flex-col items-center justify-center py-20 text-gray-500 space-y-4">
            <div class="w-10 h-10 border-4 border-indigo-500/30 border-l-indigo-500 rounded-full animate-spin"></div>
            <p class="text-sm">正在從雲端讀取資料...</p>
        </div>

        <div v-else class="space-y-4">
            <div v-if="items.length === 0" class="text-center py-20 text-gray-500">
                <p>雲端無資料</p>
                <p class="text-sm mt-2">點擊右上角 + 新增你的第一個週期</p>
            </div>

            <div v-for="item in sortedItems" :key="item.id" 
                 class="bg-gray-850 rounded-2xl p-5 card-shadow border border-gray-800 relative overflow-hidden group">
                
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-transparent to-white opacity-5 rounded-bl-full pointer-events-none"></div>

                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-lg font-bold text-white">{{ item.name }}</h3>
                        <p class="text-xs text-gray-400">週期: {{ item.cycleDays }} 天</p>
                    </div>
                    
                    <span :class="getStatusColor(item).badge" class="px-2 py-1 rounded-md text-xs font-bold uppercase tracking-wider">
                        {{ getStatusText(item) }}
                    </span>
                </div>

                <div class="flex items-baseline gap-2 my-3">
                    <span class="text-4xl font-black text-white">{{ getDaysSince(item.lastDate) }}</span>
                    <span class="text-sm text-gray-400">天前重置</span>
                </div>

                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4 overflow-hidden">
                    <div :class="getStatusColor(item).bar" class="h-2.5 rounded-full smooth-transition" :style="{ width: getProgressPercent(item) + '%' }"></div>
                </div>

                <div class="flex gap-2 mt-2">
                    <button @click="resetItem(item.id)" 
                            class="flex-1 bg-gray-700 hover:bg-gray-600 active:bg-gray-500 text-white py-2 px-4 rounded-lg text-sm font-medium smooth-transition flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        重置
                    </button>

                    <a :href="getCalendarUrl(item)" target="_blank"
                       class="bg-gray-800 hover:bg-gray-700 text-gray-300 py-2 px-3 rounded-lg flex items-center justify-center border border-gray-700 smooth-transition"
                       title="加入行事曆提醒">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </a>

                    <button @click="deleteItem(item.id)" class="text-gray-500 hover:text-red-400 px-2 smooth-transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showAddModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-80 backdrop-blur-sm">
            <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm shadow-2xl border border-gray-700">
                <h2 class="text-xl font-bold text-white mb-4">新增追蹤週期</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">任務名稱</label>
                        <input v-model="newItem.name" type="text" placeholder="例如: 剪頭髮" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">週期天數</label>
                        <input v-model.number="newItem.cycleDays" type="number" placeholder="21" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">上次執行日期</label>
                        <input v-model="newItem.lastDate" type="date" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">預設為今天，可回溯補登。</p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showAddModal = false" class="flex-1 py-3 text-gray-400 hover:text-white">取消</button>
                    <button @click="addItem" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg">新增</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        // JSONbin 設定 (已更新為專用的新 Bin)
        const BIN_ID = '6940c8b1d0ea881f402c4067';
        const MASTER_KEY = '$2a$10$KswvGv7VOFlGbWvZCr8W9uZKsQ3rJWGsV3JWj8czKDfCm1E9/c91y';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        createApp({
            setup() {
                const showAddModal = ref(false);
                const newItem = ref({ name: '', cycleDays: null, lastDate: '' });
                const items = ref([]);
                
                // 雲端同步狀態: 'idle' | 'loading' | 'saving' | 'saved' | 'error'
                const syncStatus = ref('loading');
                const isInitialLoading = ref(true);

                const getTodayString = () => {
                    const d = new Date();
                    const offset = d.getTimezoneOffset() * 60000;
                    return (new Date(d - offset)).toISOString().slice(0, 10);
                };

                // --- 雲端功能開始 ---

                const loadFromCloud = async () => {
                    syncStatus.value = 'loading';
                    try {
                        const res = await fetch(API_URL, {
                            method: 'GET',
                            headers: { 'X-Master-Key': MASTER_KEY }
                        });
                        const data = await res.json();
                        // JSONbin v3 的資料包裹在 record 屬性下
                        items.value = data.record || [];
                        syncStatus.value = 'idle';
                    } catch (e) {
                        console.error('Load failed', e);
                        syncStatus.value = 'error';
                        // 如果讀取失敗，嘗試讀取本地備份
                        const saved = localStorage.getItem('cycle-keeper-backup');
                        if (saved) items.value = JSON.parse(saved);
                    } finally {
                        isInitialLoading.value = false;
                    }
                };

                const saveToCloud = async (newItems) => {
                    syncStatus.value = 'saving';
                    try {
                        await fetch(API_URL, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-Master-Key': MASTER_KEY 
                            },
                            body: JSON.stringify(newItems)
                        });
                        syncStatus.value = 'saved';
                        setTimeout(() => { if(syncStatus.value === 'saved') syncStatus.value = 'idle'; }, 2000);
                        
                        // 順便存一份本地備份以防萬一
                        localStorage.setItem('cycle-keeper-backup', JSON.stringify(newItems));
                    } catch (e) {
                        console.error('Save failed', e);
                        syncStatus.value = 'error';
                    }
                };

                // 簡單的防抖動 (Debounce)，避免連續寫入
                let timeout = null;
                watch(items, (newVal) => {
                    // 如果還是初始讀取狀態，不要觸發存檔
                    if (isInitialLoading.value) return;

                    if (timeout) clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        saveToCloud(newVal);
                    }, 1000); // 延遲 1 秒後才存檔
                }, { deep: true });

                // --- 雲端功能結束 ---

                onMounted(() => {
                    loadFromCloud();
                });

                const syncText = computed(() => {
                    switch(syncStatus.value) {
                        case 'loading': return '讀取中...';
                        case 'saving': return '同步中...';
                        case 'saved': return '已同步';
                        case 'error': return '同步失敗';
                        default: return '';
                    }
                });

                const openAddModal = () => {
                    newItem.value = { name: '', cycleDays: null, lastDate: getTodayString() };
                    showAddModal.value = true;
                };

                const getDaysSince = (dateString) => {
                    const last = new Date(dateString); 
                    const now = new Date();
                    last.setHours(0,0,0,0); now.setHours(0,0,0,0);
                    const diffTime = now - last;
                    if (diffTime < 0) return 0;
                    return Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                };

                const getProgressPercent = (item) => {
                    const days = getDaysSince(item.lastDate);
                    return Math.min((days / item.cycleDays) * 100, 100);
                };

                const getStatusColor = (item) => {
                    const percent = (getDaysSince(item.lastDate) / item.cycleDays) * 100;
                    if (percent >= 100) return { badge: 'bg-red-500/20 text-red-400 border border-red-500/30', bar: 'bg-red-500 animate-pulse-slow' };
                    if (percent >= 75) return { badge: 'bg-amber-500/20 text-amber-400 border border-amber-500/30', bar: 'bg-amber-500' };
                    return { badge: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30', bar: 'bg-emerald-500' };
                };

                const getStatusText = (item) => {
                    const days = getDaysSince(item.lastDate);
                    if (days >= item.cycleDays) return '已過期';
                    if (days / item.cycleDays >= 0.75) return '該準備了';
                    return '狀態良好';
                };

                const getCalendarUrl = (item) => {
                    const last = new Date(item.lastDate);
                    let nextDate = new Date(last.getTime() + (item.cycleDays * 24 * 60 * 60 * 1000));
                    if (nextDate < new Date()) { nextDate = new Date(); nextDate.setDate(nextDate.getDate() + 1); }
                    const dateStr = nextDate.toISOString().replace(/-|:|\.\d\d\d/g, "").substring(0, 8);
                    const details = `該${item.name}囉！已經過了 ${item.cycleDays} 天的週期。`;
                    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(item.name)}&dates=${dateStr}/${dateStr}&details=${encodeURIComponent(details)}`;
                };

                const addItem = () => {
                    if (!newItem.value.name || !newItem.value.cycleDays || !newItem.value.lastDate) return;
                    items.value.push({
                        id: Date.now(),
                        name: newItem.value.name,
                        cycleDays: newItem.value.cycleDays,
                        lastDate: new Date(newItem.value.lastDate).toISOString()
                    });
                    showAddModal.value = false;
                };

                const resetItem = (id) => {
                    if(!confirm('確定剛剛完成了這個任務嗎？')) return;
                    const item = items.value.find(i => i.id === id);
                    if (item) item.lastDate = new Date().toISOString();
                };

                const deleteItem = (id) => {
                    if(!confirm('確定要刪除嗎？')) return;
                    items.value = items.value.filter(i => i.id !== id);
                };

                const sortedItems = computed(() => {
                    return [...items.value].sort((a, b) => {
                        const pA = getDaysSince(a.lastDate) / a.cycleDays;
                        const pB = getDaysSince(b.lastDate) / b.cycleDays;
                        return pB - pA;
                    });
                });

                return {
                    items, sortedItems, showAddModal, newItem, openAddModal, addItem, resetItem, deleteItem,
                    getDaysSince, getProgressPercent, getStatusColor, getStatusText, getCalendarUrl,
                    syncStatus, syncText, isInitialLoading
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
